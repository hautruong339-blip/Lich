<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LabGuard - Bản Sửa Lỗi Mobile</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --red: #d93025; --green: #1e8e3e; --blue: #1a73e8; --conflict-bg: #fce8e6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* Chống cuộn toàn trang gây khuất menu */
            background: #fff;
        }

        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; }
        
        header { 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #ddd; 
            background: #fff; 
            height: 60px; /* Cố định chiều cao header */
            flex-shrink: 0;
        }

        #monthLabel { font-weight: bold; font-size: 1.1rem; }
        #digitalClock { font-family: monospace; font-size: 0.9rem; color: var(--blue); font-weight: bold; }

        .calendar-container { 
            flex: 1; 
            overflow-y: auto; 
            background: #dadce0; 
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background: #dadce0;
        }

        .weekday { 
            background: #f8f9fa; 
            text-align: center; 
            font-size: 0.7rem; 
            padding: 8px 0; 
            font-weight: bold; 
            color: #70757a; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .day { 
            background: #fff; 
            padding: 2px; 
            min-height: 80px; /* Thu nhỏ để không bị chiếm chỗ */
            display: flex; 
            flex-direction: column; 
        }

        .day-num { font-size: 0.8rem; color: #70757a; margin-bottom: 2px; }
        .today .day-num { background: var(--blue); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        
        .conflict { background-color: var(--conflict-bg) !important; box-shadow: inset 0 0 0 1px var(--red); }

        .note-tag { 
            font-size: 0.6rem; 
            color: #fff; 
            padding: 2px; 
            border-radius: 3px; 
            margin-bottom: 1px; 
            text-align: center; 
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tag-red { background: var(--red); }
        .tag-green { background: var(--green); }
        .tag-blue { background: var(--blue); }
        .tag-white { background: #fff; color: #333; border: 1px solid #ccc; }

        /* MODAL NỔI LÊN TRÊN CÙNG */
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 999; 
        }
        .quick-menu { 
            display: none; 
            position: fixed; 
            bottom: 0; left: 0; right: 0; 
            background: #fff; 
            padding: 20px; 
            border-radius: 20px 20px 0 0; 
            z-index: 1000; 
            max-height: 85vh; 
            overflow-y: auto; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3); 
        }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-quick { border: none; padding: 14px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 0.9rem; outline: none; }
        .btn-white { background: #fff; color: #333; border: 1px solid #aaa; grid-column: span 2; }
        .btn-delete-item { background: #ff9800; color: white; grid-column: span 2; display: none; margin-top: 5px; }
        .btn-xoa-all { background: #e8eaed; color: #3c4043; grid-column: span 2; margin-top: 10px; padding: 10px; }
    </style>
</head>
<body>

<header>
    <div class="info-area">
        <div id="monthLabel">Tháng 1, 2026</div>
        <div id="digitalClock">00:00:00</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:2rem; color:var(--blue);">‹</button>
        <button onclick="changeMonth(1)" style="border:none; background:none; font-size:2rem; color:var(--blue);">›</button>
    </div>
</header>

<div class="calendar-container">
    <div class="calendar-grid" id="grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>
<div class="quick-menu" id="quickMenu">
    <div id="targetDate" style="margin-bottom:15px; font-weight:bold; color:var(--blue); font-size: 1rem;"></div>
    <div class="menu-grid">
        <button class="btn-quick" style="background:var(--red)" onclick="saveNote('Trực CM', 'red')">Trực CM</button>
        <button class="btn-quick" style="background:var(--red)" onclick="saveNote('Trực HC', 'red')">Trực HC</button>
        <button class="btn-quick" style="background:var(--green)" onclick="saveNote('HC 6h', 'green')">HC 6h</button>
        <button class="btn-quick" style="background:var(--green)" onclick="saveNote('LM 6h', 'green')">LM 6h</button>
        <button class="btn-quick" style="background:var(--blue)" onclick="saveNote('CM 5h', 'blue')">CM 5h</button>
        <button class="btn-quick" style="background:var(--blue)" onclick="saveNote('TN 5h', 'blue')">TN 5h</button>
        <button class="btn-quick" style="background:var(--blue)" onclick="saveNote('LM1 5h', 'blue')">LM1 5h</button>
        <button class="btn-quick" style="background:var(--blue)" onclick="saveNote('LM2 5h', 'blue')">LM2 5h</button>
        <button class="btn-quick btn-white" onclick="customWhiteNote()">+ Ghi chú trắng</button>
        <button id="btnDeleteItem" class="btn-quick btn-delete-item" onclick="deleteCurrentItem()">XÓA RIÊNG THẺ NÀY</button>
        <button class="btn-quick btn-xoa-all" onclick="clearDay()">XÓA HẾT CẢ NGÀY</button>
    </div>
</div>

<script>
    var firebaseConfig = { databaseURL: "https://aistudio-91002-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    var viewDate = new Date();
    var selectedKey = "";
    var editingColor = null;

    function updateClock() {
        var now = new Date();
        document.getElementById('digitalClock').innerText = now.toLocaleTimeString('vi-VN');
    }
    setInterval(updateClock, 1000); updateClock();

    function render() {
        var grid = document.getElementById('grid');
        grid.innerHTML = '';
        var days = ["CN", "T2", "T3", "T4", "T5", "T6", "T7"];
        days.forEach(function(d) {
            var div = document.createElement('div'); div.className = 'weekday'; div.innerText = d; grid.appendChild(div);
        });

        var y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('monthLabel').innerText = "Tháng " + (m + 1) + ", " + y;

        var firstDay = new Date(y, m, 1).getDay();
        var totalDays = new Date(y, m + 1, 0).getDate();

        for(var i=0; i<firstDay; i++) {
            var empty = document.createElement('div'); empty.className = 'day'; grid.appendChild(empty);
        }

        for(var d=1; d<=totalDays; d++) {
            (function(dayNum) {
                var key = y + "-" + (m + 1) + "-" + dayNum;
                var div = document.createElement('div');
                div.className = 'day';
                if (new Date().toDateString() === new Date(y, m, dayNum).toDateString()) div.classList.add('today');
                div.innerHTML = '<div class="day-num">' + dayNum + '</div>';
                
                var data = JSON.parse(localStorage.getItem(key) || "[]");
                var hasGreen = data.some(function(i) { return i.color === 'green' });
                var hasBlue = data.some(function(i) { return i.color === 'blue' });
                if (hasGreen && hasBlue) div.classList.add('conflict');

                data.forEach(function(item) {
                    var tag = document.createElement('div');
                    tag.className = 'note-tag tag-' + item.color;
                    tag.innerText = item.text;
                    tag.onclick = function(e) { e.stopPropagation(); openEdit(key, item.color, dayNum, m+1, y); };
                    div.appendChild(tag);
                });

                div.onclick = function() { openEdit(key, null, dayNum, m+1, y); };
                grid.appendChild(div);
            })(d);
        }
    }

    window.openEdit = function(key, color, d, m, y) {
        selectedKey = key; editingColor = color;
        document.getElementById('targetDate').innerText = "Ngày " + d + "/" + m + "/" + y;
        document.getElementById('btnDeleteItem').style.display = color ? 'block' : 'none';
        document.getElementById('quickMenu').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    window.closeMenu = function() {
        document.getElementById('quickMenu').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    window.saveNote = function(text, color) {
        var data = JSON.parse(localStorage.getItem(selectedKey) || "[]");
        var idx = data.findIndex(function(i) { return i.color === color });
        if (idx > -1) data[idx].text = text; else data.push({ text: text, color: color });
        localStorage.setItem(selectedKey, JSON.stringify(data));
        db.ref('lich_truc/' + selectedKey).set(data);
        closeMenu(); render();
    }

    window.customWhiteNote = function() {
        var txt = prompt("Ghi chú trắng:");
        if (txt) window.saveNote(txt, 'white');
    }

    window.deleteCurrentItem = function() {
        var data = JSON.parse(localStorage.getItem(selectedKey) || "[]");
        data = data.filter(function(i) { return i.color !== editingColor });
        if (data.length === 0) {
            localStorage.removeItem(selectedKey); db.ref('lich_truc/' + selectedKey).remove();
        } else {
            localStorage.setItem(selectedKey, JSON.stringify(data)); db.ref('lich_truc/' + selectedKey).set(data);
        }
        closeMenu(); render();
    }

    window.clearDay = function() {
        localStorage.removeItem(selectedKey); db.ref('lich_truc/' + selectedKey).remove();
        closeMenu(); render();
    }

    window.changeMonth = function(dir) {
        viewDate.setMonth(viewDate.getMonth() + dir); render();
    }

    db.ref('lich_truc/').on('value', function(snapshot) {
        var d = snapshot.val();
        localStorage.clear();
        if (d) Object.keys(d).forEach(function(k) { localStorage.setItem(k, JSON.stringify(d[k])); });
        render();
    });
</script>
</body>
</html>
